<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Comanda Digital</title>
    <script src="https://www.gstatic.com/firebasejs/5.9.2/firebase.js"></script>
    <script src="js/jquery-3.3.1.min.js" type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/3.1.2/rollups/aes.js"></script>
    <link rel="stylesheet" href="css/semantic/semantic.min.css">
    <script src="css/semantic/semantic.min.js" type="text/javascript"></script>
    <script type="text/javascript" src="cordova.js"></script>
    <style type="text/css">
        body {
            background-color: #F1D4AF;
        }
        body > .grid {
          height: 100%;
        }
        .image {
          margin-top: -100px;
        }
        .column {
          max-width: 450px;
        }
    </style>
</head>
<body class="text-center">
    <div class="ui middle aligned center aligned grid">
        <div class="row center aligned">
            <div class="ui column inverted segment">
                <h2 class="ui white image header">
                    <img src="img/hamburger.png" class="ui image">
                    <div class="content">
                        Cadastro de Usuário
                    </div>
                </h2>
                <form action="" class="ui large form">
                    <div class="ui stacked segment">
                        <div class="field">
                            <div class="ui left icon input">
                                <i class="user icon"></i>
                                <input type="text" name="usuario" id="usuario" placeholder="Digite seu usuario">
                            </div>
                        </div>
                        <div class="field" class="campo_senha">
                            <div class="ui left icon input">
                                <i class="lock icon"></i>
                                <input type="password" name="senha" id="senha" placeholder="Digite sua senha">
                            </div>
                        </div>
                        <div class="field" id="campo_confirmacao_senha">
                            <div class="ui left icon input">
                                <i class="lock icon"></i>
                                <input type="password" name="confirmacao_senha" id="confirmacao_senha" placeholder="Confirme sua senha">
                            </div>
                            <div class="ui pointing red basic label" id="pointing_confirm">
                                Senhas não coincidem
                            </div>
                        </div>
                        <div class="ui fluid large green submit button" onclick="novoUsuario();">Cadastrar</div>
                    </div>
                    <div class="ui error message" id="mensagem_erro">
                    </div>
                </form>
                <div class="ui grid">
                    <div class="row centered">
                        <div class="field">
                            <div class="ui action input">
                                <input type="text" id="token" name="token" placeholder="Token de funcionário">
                                <button class="ui button" onclick="lerToken()"><i class="expand icon"></i>QR Code</button>
                            </div>
                        </div>
                    </div>
                    <div class="row centered">
                        <button class="ui labeled icon teal button" onclick="window.location = 'index.html' ">
                            <i class="angle left icon"></i>
                            Voltar para Login
                        </button>
                    </div>
            </div>
        </div>
    </div>
</body>
<script>
    $(document).ready(function(){
        $("#pointing_confirm").hide();
    });

    function valida_coincidencia(){
        senha = $("#senha").val();
        confirm_senha = $("#confirmacao_senha").val();
        if(confirm_senha != senha && confirm_senha.length >= 1){
            $("#campo_confirmacao_senha").addClass("error")
            $("#pointing_confirm").show(300);
        }else{
            $("#campo_confirmacao_senha").removeClass("error");
            $("#pointing_confirm").hide(300);
        }
    };

    $("#confirmacao_senha").keyup(function(){
        valida_coincidencia();
    });

    $("#senha").keyup(function(){
        valida_coincidencia();
    });

    var config = {
        apiKey: "AIzaSyC1UdL35EsKpGZo_tNyzTQpX11ZZuEpx0g",
        authDomain: "appinventario-a8acd.firebaseapp.com",
        databaseURL: "https://appinventario-a8acd.firebaseio.com",
        projectId: "appinventario-a8acd",
        storageBucket: "appinventario-a8acd.appspot.com",
        messagingSenderId: "827922887965"
    };
    firebase.initializeApp(config);

    /*------------------------------------------------------------------------------------
        NOVO USUÁRIO
    ------------------------------------------------------------------------------------*/
    function novoUsuario(){
        var usuario = document.getElementById("usuario").value;
        var senha = document.getElementById("senha").value;
        var csenha = document.getElementById("confirmacao_senha").value;

        if(usuario == ""  || senha == "" || csenha == ""){
            $("#mensagem_erro").hide(100);
            $("#mensagem_erro").html("Preencha todos os campos necessários!");
            $("#mensagem_erro").show(300);
        }
        else if(senha != csenha){
            $("#mensagem_erro").hide(100);
            $("#mensagem_erro").html("Senha e confirmação não coincidem!");
            $("#mensagem_erro").show(300);
        }
        else{
            firebase.database().ref("usuario").child(usuario).orderByKey().once("value", snapshot => {
                //Usuário já existe no banco de dados
                if(snapshot.exists()){ 
                    $("#mensagem_erro").hide(100);
                    $("#mensagem_erro").html("Já existe um usuário com este nome!");
                    $("#mensagem_erro").show(300)
                }
                //Cadastra usuário no banco de dados
                else{ 
                    //Criptografando a senha do usuário com chave de criptografia formada pelo usuario + senha
                    var senha_criptografada = CryptoJS.AES.encrypt(senha, usuario + senha).toString();

                    var grupo = "";
                    //Nenhum token informado cadastra como cliente
                    if($("#token").val() == ""){
                        grupo = "Cliente";
                        firebase.database().ref("usuario").child(usuario).update({usuario: usuario, senha: senha_criptografada, grupo: grupo});
                        alert(grupo + " cadastrado com sucesso");
                        window.location = "index.html";
                    }
                    //Se informado um token verifica se é o correto
                    else if($("#token").val() != "180c4e8f50a356b7408cd08029083d77"){ //token = md5(prova01)
                        $("#mensagem_erro").hide(100);
                        $("#mensagem_erro").html("Token inválido!");
                        $("#mensagem_erro").show(300)
                    }
                    //Se o token tive correto cadastra como funcionário
                    else if($("#token").val() == "180c4e8f50a356b7408cd08029083d77"){
                        grupo = "Funcionario";
                        firebase.database().ref("usuario").child(usuario).update({usuario: usuario, senha: senha_criptografada, grupo: grupo});
                        alert(grupo + " cadastrado com sucesso");
                        window.location = "index.html";
                    }
                }
            }) 
        }
    }

    /*------------------------------------------------------------------------------------
        LER TOKEN EM QR CODE
    ------------------------------------------------------------------------------------*/
    function lerToken(){
        cordova.plugins.barcodeScanner.scan(
            result => { 
                document.getElementById("token").value = result.text; 
            },
            error => { 
                alert("Erro interno: " + error); 
            }
        );
    }
</script>
</html>