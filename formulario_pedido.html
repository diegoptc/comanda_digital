<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Comanda Digital</title>
        <script src="https://www.gstatic.com/firebasejs/5.9.2/firebase.js"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
        <link rel="stylesheet" href="css/semantic/semantic.min.css">
        <link rel="stylesheet" href="css/folha.css">
        <script src="js/jquery-3.3.1.min.js" type="text/javascript"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script> 
        <script type="text/javascript" src="cordova.js"></script>
    </head>

    <body>
        <ul>
            <li><a href="menu_cliente.html">Menu</a></li>
        </ul> 
        <div class="container">
            <br>
            <fieldset>
                <h2 class="ui red image header">
                    <img src="img/hamburger.png" class="ui image">
                    <div class="content">
                        <h3>Montar lanche</h3>
                    </div>
                </h2>
                <fieldset>
                    <legend>Carnes</legend>
                    <div class="form-group">
                        <div class="ui labeled button" tabindex="0">
                            <div class="ui basic blue button" onclick="addItem('presunto')" style="width: 150px">
                                Presunto
                            </div>
                            <a class="ui basic left pointing green label">R$ 0,50</a>
                            <a class="ui basic left blue label"><input id="qtdPresunto" type="text" value="0" class="input" readonly style="width: 20px"></a>
                            <div>
                                <a style="border: none" class="ui basic left red label"><button onclick="delItem('presunto')" class="btn btn-danger">X</button></a>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="ui labeled button" tabindex="0">
                            <div class="ui basic blue button" onclick="addItem('bacon')" style="width: 150px">
                                Bacon
                            </div>
                            <a class="ui basic left pointing green label">R$ 0,80</a>
                            <a class="ui basic left blue label"><input id="qtdBacon" type="text" value="0" class="input" readonly style="width: 20px"></a>
                            <div>
                                <a style="border: none" class="ui basic left red label"><button onclick="delItem('bacon')" class="btn btn-danger">X</button></a>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="ui labeled button" tabindex="0">
                            <div class="ui basic blue button" onclick="addItem('hamburguer_boi')" style="width: 150px">
                                Hamburguer de boi
                            </div>
                            <a class="ui basic left pointing green label">R$ 0,80</a>
                            <a class="ui basic left blue label"><input id="qtdBoi" type="text" value="0" class="input" readonly style="width: 20px"></a>
                            <div>
                                <a style="border: none" class="ui basic left red label"><button onclick="delItem('hamburguer_boi')" class="btn btn-danger">X</button></a>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="ui labeled button" tabindex="0">
                            <div class="ui basic blue button" onclick="addItem('salsicha')" style="width: 150px">
                            Salsicha
                            </div>
                            <a class="ui basic left pointing green label">R$ 0,80</a>
                            <a class="ui basic left blue label"><input id="qtdSalsicha" type="text" value="0" class="input" readonly style="width: 20px"></a>
                            <div>
                                <a style="border: none" class="ui basic left red label"><button onclick="delItem('salsicha')" class="btn btn-danger">X</button></a>
                            </div>
                        </div>
                    </div>
                </fieldset>

                <fieldset>
                    <legend>Vegetais</legend>
                    <div class="form-group">
                        <div class="ui labeled button" tabindex="0">
                            <div class="ui basic blue button" onclick="addItem('alface')" style="width: 150px">
                                Alface
                            </div>
                            <a class="ui basic left pointing green label">R$ 0,20</a>
                            <a class="ui basic left blue label"><input id="qtdAlface" type="text" value="0" class="input" readonly style="width: 20px"></a>
                            <div>
                                <a style="border: none" class="ui basic left red label"><button onclick="delItem('alface')" class="btn btn-danger">X</button></a>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="ui labeled button" tabindex="0">
                            <div class="ui basic blue button" onclick="addItem('tomate')" style="width: 150px">
                                Tomate
                            </div>
                            <a class="ui basic left pointing green label">R$ 0,50</a>
                            <a class="ui basic left blue label"><input id="qtdTomate" type="text" value="0" class="input" readonly style="width: 20px"></a>
                            <div>
                                <a style="border: none" class="ui basic left red label"><button onclick="delItem('tomate')" class="btn btn-danger">X</button></a>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="ui labeled button" tabindex="0">
                            <div class="ui basic blue button" onclick="addItem('picles')" style="width: 150px">
                                Picles
                            </div>
                            <a class="ui basic left pointing green label">R$ 0,50</a>
                            <a class="ui basic left blue label"><input id="qtdPicles" type="text" value="0" class="input" readonly style="width: 20px"></a>
                            <div>
                                <a style="border: none" class="ui basic left red label"><button onclick="delItem('picles')" class="btn btn-danger">X</button></a>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="ui labeled button" tabindex="0">
                            <div class="ui basic blue button" onclick="addItem('cebola')" style="width: 150px">
                                Cebola
                            </div>
                            <a class="ui basic left pointing green label">R$ 0,10</a>
                            <a class="ui basic left blue label"><input id="qtdCebola" type="text" value="0" class="input" readonly style="width: 20px"></a>
                            <div>
                                <a style="border: none" class="ui basic left red label"><button onclick="delItem('cebola')" class="btn btn-danger">X</button></a>
                            </div>
                        </div>
                    </div>
                </fieldset>

                <fieldset>
                    <legend>Adicionais</legend>
                    <div class="form-group">
                        <div class="ui labeled button" tabindex="0">
                            <div class="ui basic blue button" onclick="addItem('queijo')" style="width: 150px">
                                Queijo
                            </div>
                            <a class="ui basic left pointing green label">R$ 0,50</a>
                            <a class="ui basic left blue label"><input id="qtdQueijo" type="text" value="0" class="input" readonly style="width: 20px"></a>
                            <div>
                                <a style="border: none" class="ui basic left red label"><button onclick="delItem('queijo')" class="btn btn-danger">X</button></a>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="ui labeled button" tabindex="0">
                            <div class="ui basic blue button" onclick="addItem('milho')" style="width: 150px">
                                Milho
                            </div>
                            <a class="ui basic left pointing green label">R$ 0,50</a>
                            <a class="ui basic left blue label"><input id="qtdMilho" type="text" value="0" class="input" readonly style="width: 20px"></a>
                            <div>
                                <a style="border: none" class="ui basic left red label"><button onclick="delItem('milho')" class="btn btn-danger">X</button></a>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="ui labeled button" tabindex="0">
                            <div class="ui basic blue button" onclick="addItem('batata_palha')" style="width: 150px">
                                Batata palha
                            </div>
                            <a class="ui basic left pointing green label">R$ 0,50</a>
                            <a class="ui basic left blue label"><input id="qtdBatataPalha" type="text" value="0" class="input" readonly style="width: 20px"></a>
                            <div>
                                <a style="border: none" class="ui basic left red label"><button onclick="delItem('batata_palha')" class="btn btn-danger">X</button></a>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="ui labeled button" tabindex="0">
                            <div class="ui basic blue button" onclick="addItem('ovo_frito')" style="width: 150px">
                                Ovo frito
                            </div>
                            <a class="ui basic left pointing green label">R$ 0,60</a>
                            <a class="ui basic left blue label"><input id="qtdOvoFrito" type="text" value="0" class="input" readonly style="width: 20px"></a>
                            <div>
                                <a style="border: none" class="ui basic left red label"><button onclick="delItem('ovo_frito')" class="btn btn-danger">X</button></a>
                            </div>
                        </div>
                    </div>
                </fieldset>

                <fieldset>
                    <legend>Condimentos</legend>
                    <div class="form-group">
                        <div class="ui labeled button" tabindex="0">
                            <div class="ui basic blue button" onclick="addItem('maionese')" style="width: 150px">
                                Maionese
                            </div>
                            <a class="ui basic left pointing green label">R$ 1,00</a>
                            <a class="ui basic left blue label"><input id="qtdMaionese" type="text" value="0" class="input" readonly style="width: 20px"></a>
                            <div>
                                <a style="border: none" class="ui basic left red label"><button onclick="delItem('maionese')" class="btn btn-danger">X</button></a>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="ui labeled button" tabindex="0">
                            <div class="ui basic blue button" onclick="addItem('mostarda')" style="width: 150px">
                                Mostarda
                            </div>
                            <a class="ui basic left pointing green label">R$ 1,00</a>
                            <a class="ui basic left blue label"><input id="qtdMostarda" type="text" value="0" class="input" readonly style="width: 20px"></a>
                            <div>
                                <a style="border: none" class="ui basic left red label"><button onclick="delItem('mostarda')" class="btn btn-danger">X</button></a>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="ui labeled button" tabindex="0">
                            <div class="ui basic blue button" onclick="addItem('ketchup')" style="width: 150px">
                                Ketchup
                            </div>
                            <a class="ui basic left pointing green label">R$ 1,00</a>
                            <a class="ui basic left blue label"><input id="qtdKetchup" type="text" value="0" class="input" readonly style="width: 20px"></a>
                            <div>
                                <a style="border: none" class="ui basic left red label"><button onclick="delItem('ketchup')" class="btn btn-danger">X</button></a>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="ui labeled button" tabindex="0">
                            <div class="ui basic blue button" onclick="addItem('barbecue')" style="width: 150px">
                                Barbecue
                            </div>
                            <a class="ui basic left pointing green label">R$ 3,00</a>
                            <a class="ui basic left blue label"><input id="qtdBarbecue" type="text" value="0" class="input" readonly style="width: 20px"></a>
                            <div>
                                <a style="border: none" class="ui basic left red label"><button onclick="delItem('barbecue')" class="btn btn-danger">X</button></a>
                            </div>
                        </div>
                    </div>
                </fieldset>
                <fieldset>
                    <legend>Comanda</legend>
                    <div style="display: none">
                        <textarea type="text" id="itens_aux" readonly></textarea>
                    </div>
                    <div id="itens" class="form-group">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Quantidade</th>
                                </tr>
                            </thead>
                            <tbody id="dados">

                            </tbody>
                        </table>
                    </div>
                    <div id="opcoes" class="ui buttons">
                        <label for="valor">Valor total em R$</label>
                        <input class="form-control" type="text" id="valor" placeholder="0.00" readonly>
                        <button class="ui positive button" onclick="fazerPedido()">Fazer pedido</button>
                        <div class="or" data-text=""></div>
                        <button class="ui negative button" onclick="limparPedido()">Cancelar</button>
                    </div>
                </fieldset>
            </fieldset>
        </div>
    </body>
    <script>
        /*------------------------------------------------------------------------------------
            INICIALIZAÇÃO DO FIREBASE
        ------------------------------------------------------------------------------------*/
        var config = {
            apiKey: "AIzaSyC1UdL35EsKpGZo_tNyzTQpX11ZZuEpx0g",
            authDomain: "appinventario-a8acd.firebaseapp.com",
            databaseURL: "https://appinventario-a8acd.firebaseio.com",
            projectId: "appinventario-a8acd",
            storageBucket: "appinventario-a8acd.appspot.com",
            messagingSenderId: "827922887965"
        };
        firebase.initializeApp(config);

        $(document).ready(function(){
            soma_tudo();
        });
    
        var itens = {
            'presunto': {
                'quantidade' : 0,
                'valor' : 0.5,
                'total': 0
            },
            'bacon': {
                'quantidade' : 0,
                'valor': 0.8,
                'total': 0
            },
            'hamburguer_boi': {
                'quantidade': 0,
                'valor' : 0.8,
                'total': 0
            },
            'salsicha': {
                'quantidade': 0,
                'valor' : 0.8,
                'total': 0
            },
            'alface': {
                'quantidade': 0,
                'valor': 0.2,
                'total': 0
            },
            'tomate': {
                'quantidade': 0,
                'valor': 0.5,
                'total': 0
            },
            'picles': {
                'quantidade': 0,
                'valor': 0.5,
                'total': 0
            },
            'cebola': {
                'quantidade': 0,
                'valor': 0.10,
                'total': 0
            },
            'queijo': {
                'quantidade': 0,
                'valor': 0.5,
                'total': 0
            },
            'milho':{
                'quantidade': 0,
                'valor': 0.5,
                'total': 0
            },
            'batata_palha':{
                'quantidade': 0,
                'valor': 0.5,
                'total': 0
            },
            'ovo_frito':{
                'quantidade': 0,
                'valor': 0.6,
                'total': 0
            },
            'maionese':{
                'quantidade': 0,
                'valor': 1.0,
                'total': 0
            },
            'mostarda':{
                'quantidade': 0,
                'valor': 1.0,
                'total': 0
            },
            'ketchup':{
                'quantidade': 0,
                'valor': 1.0,
                'total': 0
            },
            'barbecue':{
                'quantidade': 0,
                'valor': 3.00,
                'total': 0
            }
        };

        function retorna_itens(){
            return itens;
        }

        function atualiza_quantidades(){
            itens = retorna_itens();
            $("#qtdPresunto").val(itens['presunto']['quantidade']);
            $("#qtdBacon").val(itens['bacon']['quantidade']);
            $("#qtdBoi").val(itens['hamburguer_boi']['quantidade']);
            $("#qtdSalsicha").val(itens['salsicha']['quantidade']);
            $("#qtdAlface").val(itens['alface']['quantidade']);
            $("#qtdTomate").val(itens['tomate']['quantidade']);
            $("#qtdPicles").val(itens['picles']['quantidade']);
            $("#qtdCebola").val(itens['cebola']['quantidade']);
            $("#qtdQueijo").val(itens['queijo']['quantidade']);
            $("#qtdMilho").val(itens['milho']['quantidade']);
            $("#qtdBatataPalha").val(itens['batata_palha']['quantidade']);
            $("#qtdOvoFrito").val(itens['ovo_frito']['quantidade']);
            $("#qtdMaionese").val(itens['maionese']['quantidade']);
            $("#qtdMostarda").val(itens['mostarda']['quantidade']);
            $("#qtdKetchup").val(itens['ketchup']['quantidade']);
            $("#qtdBarbecue").val(itens['barbecue']['quantidade']);
        }

        function soma_tudo(){
            itens = retorna_itens();
            soma = 0.0;
            for(var item in itens){
                itens[item]['total'] = itens[item]['quantidade'] * itens[item]['valor'];
                soma += itens[item]['total'];
            }
            soma = parseFloat(soma).toFixed(2);
            $("#valor").val('R$ ' + soma);
        }

        function configura_nome(nome){
            nome_aux = '';
            espaco = 0;
            for (key in nome){
                if(key == 0){
                    nome_aux += nome[key].toUpperCase();
                }else if(nome[key] == '_'){
                    nome_aux += ' '
                    espaco = 1;
                }else if(espaco == 1) {
                    nome_aux += nome[key].toUpperCase();
                    espaco = 0;
                }else{
                    nome_aux += nome[key];
                }   
            }
            return nome_aux;
        }

        function atualiza_tabela(){
            itens = retorna_itens();
            conteudo = '';
            for (item in itens) {
                if(itens[item]['quantidade'] > 0) {
                    nome = configura_nome(item);
                    conteudo += '<tr>';
                    conteudo +=     '<td>'+nome+'</td>';
                    conteudo +=     '<td>'+itens[item]["quantidade"]+'</td>'
                    conteudo += '</tr>';
                }
            }
            $("#dados").html(conteudo);
        }

        /*------------------------------------------------------------------------------------
            CALCULAR PEDIDO DE CLIENTE - ADICIONAR ITEM
        ------------------------------------------------------------------------------------*/
        //Adicionar itens ao lanche final
        function addItem(produto){
            //retorna na varivel itens o objeto de itens
            itens = retorna_itens();
            
            //itens produto recebido como parametro adiciona +1
            itens[produto]['quantidade'] += 1;
            
            //chama a função de atualizar_quantidades para interface
            atualiza_quantidades();
            
            //chama a função para atualizar a soma
            soma_tudo();

            //chama a função para atualizar a tabela
            atualiza_tabela();
            
            /*

            //Recupera o valor  unitário do ite
            var valorAux = parseFloat(valor);
            //Se ainda não tiver nenhum pedido
            if(document.getElementById("valor").value == ""){
                document.getElementById("valor").value = valorAux.toFixed(2);
            }
            //Se não soma com o valor atual
            else{
                document.getElementById("valor").value = (parseFloat(document.getElementById("valor").value) + valorAux).toFixed(2);
            }

            //** Oculto **/
            /*
            //Insere o item na lista
            document.getElementById("itens_aux").value += itens[0][quantidadeID] + "," ;
            //Divide os itens
            const lista = document.getElementById("itens_aux").value.toString().split(",");
            //Elimina repetições
            const listaSemRepeticoes = [...new Set(lista)];
            //Insere a nova lista
            document.getElementById("itens_aux").value = listaSemRepeticoes.toString();

            //** Visivel **/
            /*
            //Recupera a lista atual
            var tabela = "<tr><th>Item</th><th>Quantidade</th></tr>";
            listaSemRepeticoes.forEach(obj => {
                //console.log(obj.toString())
                if(obj != ""){
                    var qtdItem = "";
                    //Gambiarra para encontrar o id do item através do nome
                    if(obj.toString() == "Batata-palha"){
                        qtdItem = "qtdBatataPalha";
                    }
                    else if(obj.toString() == "Hambuguer de boi"){
                        qtdItem = "qtdBoi"; 
                    }
                    else if(obj.toString() == "Ovo frito"){
                        qtdItem = "qtdOvoFrito";
                    }
                    else{
                        qtdItem = "qtd" + obj.toString(); 
                    }
                
                    tabela += "<tr><td>"+ obj + "</td><td>" + document.getElementById(qtdItem).value + "</td></tr>";
                }
            })
            document.getElementById("tabela").innerHTML = tabela;
            */
        }

        /*------------------------------------------------------------------------------------
            CALCULAR PEDIDO DE CLIENTE - REMOVER ITEM
        ------------------------------------------------------------------------------------*/
        function delItem(produto){
            itens = retorna_itens();
            if(itens[produto]['quantidade'] > 0) {
                itens[produto]['quantidade'] -= 1;
            }else{
                alert('O item já é igual a 0');
            }
            atualiza_quantidades();
            soma_tudo();
            atualiza_tabela();

            //Verifica se a quantidade não é zero
            /*
            if(document.getElementById(quantidadeID).value != 0 && 1==2){
                //Decrementa a quantidade do item
                document.getElementById(quantidadeID).value = parseInt(document.getElementById(quantidadeID).value) - 1;
                //Recupera o valor  unitário do item
                var valorAux = parseFloat(valor);
                //Decrementa o valor do item no valor total R$
                document.getElementById("valor").value = (parseFloat(document.getElementById("valor").value) - valorAux).toFixed(2);
                //Atualiza a lista de pedidos
                //Nomes dos itens
                var itens = 
                [{
                    qtdPresunto: "Presunto",
                    qtdBoi: "Hambuguer de boi",
                    qtdBacon: "Bacon",
                    qtdSalsicha: "Salsicha",
                    qtdAlface: "Alface",
                    qtdTomate: "Tomate",
                    qtdPicles: "Picles",
                    qtdCebola: "Cebola",
                    qtdQueijo: "Queijo",
                    qtdMilho: "Milho",
                    qtdBatataPalha: "Batata-palha",
                    qtdOvoFrito: "Ovo frito",
                    qtdMaionese: "Maionese",
                    qtdMostarda: "Mostarda",
                    qtdKetchup: "Ketchup",
                    qtdBarbecue: "Barbecue"
                }]

                const lista = document.getElementById("itens_aux").value.toString().split(",");
                //Encontra o index do item inserido
                var index = lista.indexOf(itens[0][quantidadeID]);

                if(index !== -1) {
                    //Remove caso já existir
                    lista.splice(index, 1);
                }
                //Atualiza a lista
                document.getElementById("itens_aux").value = lista.toString();

                //Atualiza a tabela
                var tabela = "<tr><th>Item</th><th>Quantidade</th></tr>";
                lista.forEach(obj => {
                    if(obj != ""){
                        var qtdItem = "";
                        //Gambiarra para encontrar o id do item através do nome
                        if(obj.toString() == "Batata-palha"){
                            qtdItem = "qtdBatataPalha";
                        }
                        else if(obj.toString() == "Hambuguer de boi"){
                            qtdItem = "qtdBoi"; 
                        }
                        else if(obj.toString() == "Ovo frito"){
                            qtdItem = "qtdOvoFrito";
                        }
                        else{
                            qtdItem = "qtd" + obj.toString(); 
                        }
                    
                        tabela += "<tr><td>"+ obj + "</td><td>" + document.getElementById(qtdItem).value + "</td></tr>";
                    }
                })
                document.getElementById("tabela").innerHTML = tabela;
            }
            */
        }

        /*------------------------------------------------------------------------------------
            FAZER PEDIDO - LER QR CODE DA MESA
        ------------------------------------------------------------------------------------*/
        function fazerPedido(){
            //Verifica se existe algo no pedido
            if(document.getElementById("valor").value == 0){
                alert("Monte seu lanche antes de fazer o pedido.");
            }
            else{
                var result = confirm("Seu pedido ficou em R$ " + document.getElementById("valor").value +  "\nA câmera será aberta para você ler o QR Code de sua mesa e prosseguir com o pedido.")
                if(result){
                    cordova.plugins.barcodeScanner.scan(
                        result => {
                            //Recupera o número da mesa
                            var numeroMesa = result.text.toString();
                            firebase.database().ref("mesa").child(numeroMesa).orderByKey().once("value", snapshot => {
                                //Se a mesa existir após a leitura do QR Code
                                if(snapshot.exists()){
                                    //Recupera o cliente
                                    var usuario = localStorage.getItem("usuarioLogado"); //Recupera o usuário logado (em cache)
                                    //Recupera os itens do pedido
                                    var pedido = document.getElementById("itens_aux").value;
                                    //Recupera o valor do pedido
                                    var valor = "R$ " + document.getElementById("valor").value;
                                    //Cadastra o pedido com as informações recuperadas
                                    firebase.database().ref("pedido").push({cliente: usuario, mesa: numeroMesa, pedido: pedido, valor: valor, status: "Na fila"})
                                    
                                    alert("Seu pedido foi enviado para cozinha, aguarde um pouco :D");
                                    location.href = "menu_cliente.html";
                                }
                                //Se for lido outro QR Code
                                else{
                                    alert("Não há nenhuma mesa relacionada com este QR Code!");
                                }
                            })
                        },
                        error => {
                            alert("Verifique as permissões para uso da câmera!" + error);
                        }
                    );
                }
            }
        }

        /*------------------------------------------------------------------------------------
           LIMPAR CAMPOS
        ------------------------------------------------------------------------------------*/
        function limparPedido(){
            result = confirm("Tem certeza que deseja cancelar?");
            if(result){
                itens = retorna_itens();
                for (item in itens){
                    itens[item]['quantidade'] = 0
                }
                atualiza_quantidades();
                soma_tudo();
            }
        };

    </script>
</html>